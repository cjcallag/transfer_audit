---
title: ""
output: html_document
---

</br>

```{css, echo = FALSE}
html *
  {
    color: #808080
    font-family: Arial !important;
  }

.leaflet {
  height: calc(100vh - 175px) !important;
  width: 100% !important;}

.leaflet .legend {
  font-size: 10px;
  line-height: 20px;
  opacity: 0.90;
}

.leaflet .leaflet-control-layers-expanded {
  opacity: 0.90;
  font-size: 10px;
  line-height: 20px;
}

.leaflet .leaflet-control {
  opacity: 0.90;
}

th, td {
  padding: 5px;
  text-align: left;
}

a:hover {
  color: #FF0000;
  font-size: 110%;
}

tr:hover {background-color: #f5f5f5;}

#compacttable th, td{
  padding: 0.5px;
}

.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 50%;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(leaflet)
library(sf)
# Get data =====================================================================
fo <- sf::st_read("https://maps.fodis.net/server/rest/services/OpenData/AdministrativeBoundaries/FeatureServer/4/query?where=1%3D1&outFields=*&outSR=4326&f=json")
wants <- read.csv("data.csv")
api_url <- "https://maps.fodis.net/server/rest/services/OpenData/AdministrativeBoundaries/FeatureServer/1/query?where=1%3D1&outFields=*&outSR=4326&f=json"

fora <- sf::st_read(api_url) 
fora <- merge(fora[fora$parcel_id %in% wants$COE, ], wants, by.x = "parcel_id", by.y = "COE") %>%
  distinct(parcel_id, .keep_all = TRUE)
```

```{r, echo = FALSE, fig.align='center'}
fora[["color"]] <- ifelse(fora[["Match.Owner"]] == "FORT ORD REUSE AUTHORITY", "red", "blue")
fora[["color"]] <- ifelse(fora[["Match.Owner"]] == "", "yellow", fora[["color"]])
fora[["color"]] <- ifelse(fora[["Match.Owner"]] == "" & fora[["Note"]] == "Road", "white", fora[["color"]])
# Map ==========================================================================
leaflet() %>%
  addProviderTiles(provider = providers[['Esri.WorldGrayCanvas']],
                   group    = "Imagery") %>%
  setView(lng = -121.775, lat = 36.63,
            zoom = 12.3) %>%
  addMeasure(position          = "topright",
             primaryLengthUnit = "feet", 
             primaryAreaUnit   = "acres") %>%
  addPolygons(data = fo, fill = FALSE, weight = 2, color = "grey",
              opacity = 1, dashArray = 4, 
              label = "Former Fort Ord Boundary") %>%
  addPolygons(data = fora, fill = TRUE, color = "black", label = ~parcel_id,
              fillColor = fora[["color"]],
              popup = case_when(fora[["Match.Owner"]] == "" & fora[["Note"]] == "Road" ~ paste0("<table>",
                                                                                                "<tr><th>COE: </th><td>", fora[["parcel_id"]], "</td></tr>",
                                                                                                "<tr><th>Note: </th><td>No APN on record for this parcel.</td></tr></table>"),
                                fora[["Match.Owner"]] == "" ~ paste0("<table>",
                                                                     "<tr><th>COE: </th><td>", fora[["parcel_id"]], "</td></tr>",
                                                                     "<tr><th>APN: </th><td>", fora[["Match.APN"]], "</td></tr>",
                                                                     "<tr><th>Note: </th><td>No ownership data found for this parcel. </td></tr></table>"),
                             fora[["Match.Owner"]] != "" ~ paste0("<table>",
                            "<tr><th>COE: </th><td>", fora[["parcel_id"]], "</td>",
                            "<tr><th>APN: </th><td>", fora[["Match.APN"]], "</td>",
                            "<tr><th>Owner: </th><td>", fora[["Match.Owner"]], "</td>",
                            "<tr><th>Deed: </th><td>", fora[["Match.Deed"]], "</td>",
                            "</table>")),
              opacity = 1, weight = 1, fillOpacity = 0.5) %>%
  addLegend(color = c("white", "red", "yellow", "blue"),
            labels = c("No APN", "FORA Owned", "Records pending", "Transfer complete"),
            opacity = 1, position = "bottomright",
            title = "Parcel Status")
```

